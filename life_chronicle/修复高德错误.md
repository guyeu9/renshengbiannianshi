<details type="reasoning" done="true" duration="32">
<summary>Thought for 32 seconds</summary>
&gt; The error is clear: `AMapFlutterMapPlugin` cannot be found. This is a Flutter project using the `amap_flutter_map` plugin, and the plugin class is not being found during compilation.
&gt; 
&gt; Let me analyze the issue:
&gt; 
&gt; 1. The error is in `GeneratedPluginRegistrant.java` which is auto-generated by Flutter
&gt; 2. It&#x27;s trying to use `com.amap.flutter.map.AMapFlutterMapPlugin` but the class cannot be found
&gt; 3. This is likely because the `amap_flutter_map` package is either not properly added or there&#x27;s a version conflict
&gt; 
&gt; The project is a Flutter project. Let me think about the solutions:
&gt; 
&gt; 
&gt; I need to check if the `amap_flutter_map` dependency is properly declared in `pubspec.yaml` and whether it&#x27;s compatible with the current Flutter and Android setup. The real issue is that the plugin&#x27;s Android code isn&#x27;t being compiled or included, which could stem from a version incompatibility, unresolved Android dependencies, or a missing or outdated package variant.
&gt; 
&gt; Looking at the error more closely, the `AMapFlutterMapPlugin` class isn&#x27;t being found, which suggests either the plugin was restructured, the installed version doesn&#x27;t contain this class, or there&#x27;s a dependency conflict preventing proper resolution.
&gt; 
&gt; The fix likely involves updating `amap_flutter_map` to a newer version that includes the proper Android plugin class, then running `flutter pub get` to resolve dependencies. If that doesn&#x27;t work, I might need to check the `pubspec.yaml` to ensure the plugin is correctly declared or consider using an alternative mapping solution. The real issue is likely that the plugin dependency is declared in `pubspec.yaml` but the Android build isn&#x27;t actually pulling in the compiled plugin code—either because `flutter pub get` wasn&#x27;t run after adding it, or there&#x27;s a Gradle/AGP version conflict preventing the Android artifact from being found. I should walk through verifying the `pubspec.yaml` configuration, checking the build.gradle settings for compatibility, and potentially manually configuring the plugin registration if needed. The package exists but the class isn&#x27;t being found, which suggests either a version mismatch where the plugin was refactored or the Android implementation isn&#x27;t being included in the build properly. I should try clearing the Flutter cache and regenerating the plugin registrant, or check if there&#x27;s a newer version of the plugin that changed the class structure.
&gt; 
&gt; Now I&#x27;m thinking through the practical fixes for this CI/CD setup—updating the pubspec dependencies, configuring the Android build gradle properly, adding proguard rules, and ensuring Android 15 compatibility, then fixing the GitHub Actions workflow to handle all of this correctly.
</details>
# Flutter 高德地图 SDK 编译+运行双重错误修复

## 问题分析

```
错误1（编译期）: AMapFlutterMapPlugin 类找不到
错误2（运行期）: Android 15 JNI GetStaticMethodID crash

原因链：
pubspec.yaml插件版本不兼容
    → GeneratedPluginRegistrant.java引用了不存在的类
        → 编译失败
            → 即使编译过，旧版SDK在Android15会JNI崩溃
```

---

## 完整修复方案

### Step 1：更新 pubspec.yaml

```yaml
dependencies:
  flutter:
    sdk: flutter

  # ✅ 使用最新兼容版本
  amap_flutter_map: ^3.0.0
  amap_flutter_location: ^3.0.0

  # 如果上面版本仍有问题，锁定到以下稳定版
  # amap_flutter_map: 3.0.0
  # amap_flutter_location: 3.0.0
```

---

### Step 2：android/app/build.gradle

```gradle
android {
    compileSdkVersion 35  // Android 15
    
    defaultConfig {
        applicationId "com.suliuzhe.lifechronicle"
        minSdkVersion 21
        targetSdkVersion 35
        
        // ✅ 多ABI支持，防止so加载失败
        ndk {
            abiFilters 'armeabi-v7a', 'arm64-v8a'
        }
    }

    buildTypes {
        release {
            minifyEnabled true
            shrinkResources true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'),
                         'proguard-rules.pro'
        }
        debug {
            minifyEnabled false
        }
    }
    
    // ✅ 解决 so 文件冲突
    packagingOptions {
        pickFirst 'lib/arm64-v8a/libssl.so'
        pickFirst 'lib/arm64-v8a/libcrypto.so'
        pickFirst 'lib/armeabi-v7a/libssl.so'
        pickFirst 'lib/armeabi-v7a/libcrypto.so'
    }
    
    // ✅ Java 版本兼容性
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_11
        targetCompatibility JavaVersion.VERSION_11
    }
    
    kotlinOptions {
        jvmTarget = '11'
    }
}

dependencies {
    // ✅ 手动指定高德SDK版本确保Android15兼容
    implementation 'com.amap.api:3dmap:10.1.200'
    implementation 'com.amap.api:location:6.4.9'
    implementation 'com.amap.api:search:9.7.4'
}
```

---

### Step 3：android/build.gradle

```gradle
buildscript {
    ext.kotlin_version = '1.9.0'
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:8.2.2'
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
        // ✅ 高德SDK仓库
        maven { url 'https://jitpack.io' }
        maven { url "https://maven.aliyun.com/repository/public" }
    }
}
```

---

### Step 4：proguard-rules.pro

```proguard
# ==================== 高德地图完整混淆规则 ====================
-keep class com.amap.api.** { *; }
-keep class com.autonavi.** { *; }
-keep class com.a.a.** { *; }
-keep class com.loc.** { *; }
-keep class com.amap.flutter.** { *; }

# Flutter 高德插件类
-keep class com.amap.flutter.map.AMapFlutterMapPlugin { *; }
-keep class com.amap.flutter.location.** { *; }

# 防止JNI相关类被混淆（Android 15关键）
-keepclasseswithmembernames,includedescriptorclasses class * {
    native <methods>;
}

-dontwarn com.amap.api.**
-dontwarn com.autonavi.**
-dontwarn com.a.a.**

# Flutter相关
-keep class io.flutter.** { *; }
-keep class io.flutter.plugins.GeneratedPluginRegistrant { *; }
```

---

### Step 5：Android 15 隐私合规初始化

```kotlin
// android/app/src/main/kotlin/com/suliuzhe/lifechronicle/MainActivity.kt
package com.suliuzhe.lifechronicle

import android.os.Bundle
import io.flutter.embedding.android.FlutterActivity
import io.flutter.embedding.engine.FlutterEngine
import com.amap.api.maps.MapsInitializer
import com.amap.api.location.AMapLocationClient

class MainActivity : FlutterActivity() {
    
    override fun onCreate(savedInstanceState: Bundle?) {
        // ✅ 必须在super之前初始化隐私合规
        initAMapPrivacy()
        super.onCreate(savedInstanceState)
    }

    override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
        super.configureFlutterEngine(flutterEngine)
    }
    
    private fun initAMapPrivacy() {
        try {
            // ✅ Android 15 必须调用，否则JNI加载失败
            MapsInitializer.updatePrivacyShow(this, true, true)
            MapsInitializer.updatePrivacyAgree(this, true)
            AMapLocationClient.updatePrivacyShow(this, true, true)
            AMapLocationClient.updatePrivacyAgree(this, true)
        } catch (e: Exception) {
            android.util.Log.e("AMap", "隐私初始化失败: ${e.message}")
        }
    }
}
```

---

### Step 6：Flutter层 - 地图页面防崩溃处理

```dart
// lib/pages/map_page.dart
import 'package:flutter/material.dart';
import 'package:amap_flutter_map/amap_flutter_map.dart';
import 'package:amap_flutter_location/amap_flutter_location.dart';

class MapPage extends StatefulWidget {
  const MapPage({Key? key}) : super(key: key);

  @override
  State<MapPage> createState() => _MapPageState();
}

class _MapPageState extends State<MapPage> {
  AMapController? _mapController;
  bool _mapLoadFailed = false;
  
  // ✅ API Key配置
  static const AMapApiKey _amapApiKey = AMapApiKey(
    androidKey: "your_android_api_key",
    iosKey: "your_ios_api_key",
  );

  @override
  void initState() {
    super.initState();
    _initLocation();
  }

  Future<void> _initLocation() async {
    // ✅ 隐私合规 - Dart层也需要设置
    AMapFlutterLocation.updatePrivacyShow(true, true);
    AMapFlutterLocation.updatePrivacyAgree(true);
  }

  @override
  Widget build(BuildContext context) {
    if (_mapLoadFailed) {
      return _buildErrorWidget();
    }
    
    return Scaffold(
      appBar: AppBar(title: const Text('地图')),
      body: _buildMapWidget(),
    );
  }

  Widget _buildMapWidget() {
    return AMapWidget(
      apiKey: _amapApiKey,
      // ✅ 隐私合规
      privacyStatement: const AMapPrivacyStatement(
        hasShow: true,
        hasAgree: true,
        hasContains: true,
      ),
      onMapCreated: (controller) {
        setState(() {
          _mapController = controller;
        });
      },
      // ✅ 错误处理
      gestureRecognizers: const {},
    );
  }

  Widget _buildErrorWidget() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const Icon(Icons.map_outlined, size: 64, color: Colors.grey),
          const SizedBox(height: 16),
          const Text('地图加载失败', style: TextStyle(fontSize: 18)),
          const SizedBox(height: 8),
          ElevatedButton(
            onPressed: () => setState(() => _mapLoadFailed = false),
            child: const Text('重试'),
          ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _mapController?.dispose();
    super.dispose();
  }
}
```

---

### Step 7：修复 GitHub Actions 工作流

```yaml
# .github/workflows/build.yml
name: Build Android Release

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'  # ✅ 使用Java 17

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'  # ✅ 指定Flutter版本
          channel: 'stable'

      # ✅ 关键：清理缓存避免插件冲突
      - name: Clean Flutter
        run: |
          flutter clean
          flutter pub cache repair

      - name: Get dependencies
        run: flutter pub get

      # ✅ 生成GeneratedPluginRegistrant（解决编译错误）
      - name: Run Flutter Gen
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: Build APK
        run: |
          flutter build apk --release \
            --target-platform android-arm64 \
            --no-tree-shake-icons

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
```

---

## 排查清单

```bash
# 本地执行以下命令验证修复
flutter clean                          # 1. 清理构建缓存
rm -rf ~/.pub-cache/hosted/            # 2. 清理pub缓存（可选）
flutter pub cache repair               # 3. 修复pub缓存
flutter pub get                        # 4. 重新获取依赖
flutter pub deps | grep amap           # 5. 确认amap包版本
flutter build apk --debug             # 6. 先测试debug包
flutter build apk --release           # 7. 再测试release包
```

---

## 问题对应关系总结

| 错误 | 原因 | 修复 |
|------|------|------|
| `AMapFlutterMapPlugin not found` | 插件版本不匹配/缓存问题 | 更新版本+flutter clean |
| `java_class == null` JNI crash | Android 15严格JNI检查+旧SDK | 升级SDK+隐私合规初始化 |
| CI/CD编译失败 | 缓存脏数据 | workflow加clean步骤 |