# 人生编年史 APP 完整开发设计方案

---

## 一、技术架构总览

```
┌─────────────────────────────────────────────────────────┐
│                    Flutter 客户端                         │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌─────────┐ │
│  │  UI 层     │ │ 状态管理   │ │ 本地AI管线 │ │ 同步引擎 │ │
│  │ (Widgets)  │ │ (Riverpod)│ │ (Pipeline) │ │(WebDAV) │ │
│  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └────┬────┘ │
│        └──────────────┴─────────────┴────────────┘      │
│                         │                                │
│              ┌──────────┴──────────┐                     │
│              │   Drift (SQLite)    │                     │
│              │  + FTS5 + SQLCipher │                     │
│              └─────────────────────┘                     │
│                         │                                │
│              ┌──────────┴──────────┐                     │
│              │  本地文件系统        │                     │
│              │  图片/视频/导出文件   │                     │
│              └─────────────────────┘                     │
└─────────────────────────────────────────────────────────┘
                │
            ┌─────────────┴─────────────┐
            │    联网 API（仅 AI 调用）    │
            │  DeepSeek / 通义千问 / Claude │
            └───────────────────────────┘
```

核心原则：**数据全部在本地**，没有自建后端，没有云数据库。联网只做两件事：调 AI 大模型 API、调 Embedding API。同步只走 WebDAV 网盘（如坚果云）[1]。

---

## 二、技术选型清单

| 层级 | 选型 | 理由 |
|---|---|---|
| 跨端框架 | Flutter 3.x (Dart) | 一套代码先出 Android 后出 iOS；自绘引擎对 PRD 要求的大量动效（彩带、气泡、涟漪、骨架屏）实现成本最低 [1] |
| 状态管理 | Riverpod | 模块多、实体关联复杂，Riverpod 的 Provider 依赖树比 Bloc 更适合"万物关联"的数据流 |
| 本地数据库 | Drift (SQLite) + FTS5 | 关系型结构完美匹配 PRD 的六大实体关联模型 [1]；FTS5 提供全文检索能力 |
| 本地加密 | SQLCipher + Keystore/Keychain | PRD 要求"加密备份" [1]，数据库层面加密最彻底 |
| 地图 SDK | 高德地图 Flutter 插件 | 国内场景，味觉地图 + 旅行足迹地图 [1] |
| PDF 导出 | dart_pdf + printing | 人生传记 PDF、年度味觉地图长图、行程导出 [1] |
| EPUB 导出 | epubx (Dart) | 人生传记 EPUB 格式 [1] |
| 图片 OCR | Google ML Kit (离线) | 本地识别菜单/票据/招牌文字，不上传图片 |
| 图片标签 | Google ML Kit Image Labeling | 本地输出"海滩/寿司/咖啡"等标签 |
| EXIF 提取 | exif (Dart package) | 提取拍摄时间、经纬度、设备信息 |
| WebDAV 同步 | webdav_client (Dart) | 增量备份到坚果云等网盘 [1] |
| AI 大模型 | DeepSeek / 通义千问 API | 联网调用，用于意图解析、情绪总结、社交洞察、年度报告文案生成 |
| Embedding | bge-m3 API 或 text-embedding-3 | 联网调用，为记录生成向量，存本地做语义检索 |
| 本地向量存储 | SQLite BLOB 字段 | 向量存本地，查询时 Dart 侧做余弦相似度计算 |

### 2.x Windows 本地开发环境（Flutter）

- Flutter SDK：放置在 `_toolchain/flutter`，并设置国内镜像环境变量：
  - `PUB_HOSTED_URL=https://pub.flutter-io.cn`
  - `FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn`
- 关键前置条件（Windows 桌面）：需要启用系统“开发者模式”或使用管理员权限运行终端，否则无法创建符号链接，包含插件的 `flutter pub get / flutter run` 会失败（Flutter 会提示 “Building with plugins requires symlink support.”）。
- 编译级验证基线：当前仓库以 `flutter analyze` + `flutter test` 作为最小可重复验证；网络图片会在测试中使用 HttpClient 桩，避免测试运行时的网络依赖。
- 构建验证基线：当前环境已通过 `flutter build web`，可用于持续集成的首个稳定目标；Windows 桌面构建仍依赖本机安装 Visual Studio（Desktop development with C++）。

---

## 三、数据库设计（Drift/SQLite）

### 3.1 六大核心实体表

PRD 定义了六大关联实体 [1]，数据库按以下结构设计：

```sql
-- 美食实体
CREATE TABLE food_records (
  id TEXT PRIMARY KEY,          -- UUID
  title TEXT NOT NULL,          -- 店名/菜名
  content TEXT,                 -- 详细描述
  images TEXT,                  -- JSON数组：本地图片路径列表
  tags TEXT,                    -- JSON数组：标签列表
  rating REAL,                  -- 1-5星评分
  price_per_person REAL,        -- 人均消费
  link TEXT,                    -- 超链接
  latitude REAL,                -- 纬度
  longitude REAL,               -- 经度
  poi_name TEXT,                -- POI名称（如"海底捞春熙路店"）
  city TEXT,                    -- 城市
  mood TEXT,                    -- 关联心情
  is_wishlist INTEGER DEFAULT 0,-- 0=已品尝 1=心愿清单
  wishlist_done INTEGER DEFAULT 0,
  record_date TEXT NOT NULL,    -- 记录日期 YYYY-MM-DD
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  is_deleted INTEGER DEFAULT 0  -- 软删除
);

-- 小确幸实体
CREATE TABLE moment_records (
  id TEXT PRIMARY KEY,
  content TEXT,
  images TEXT,                  -- JSON数组
  mood TEXT NOT NULL,           -- 心情标签
  mood_color TEXT,              -- 心情对应颜色
  scene_tag TEXT,               -- 场景标签（居家/读书/电影/户外）
  latitude REAL,
  longitude REAL,
  city TEXT,
  record_date TEXT NOT NULL,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  is_deleted INTEGER DEFAULT 0
);

-- 旅行实体
CREATE TABLE travel_records (
  id TEXT PRIMARY KEY,
  trip_id TEXT NOT NULL,        -- 所属行程ID（一次旅行多条记录）
  title TEXT,
  content TEXT,
  images TEXT,
  destination TEXT,             -- 目的地
  latitude REAL,
  longitude REAL,
  city TEXT,
  mood TEXT,
  expense_transport REAL,       -- 交通花费
  expense_hotel REAL,           -- 住宿花费
  expense_food REAL,            -- 美食花费
  expense_ticket REAL,          -- 景点花费
  is_wishlist INTEGER DEFAULT 0,-- 0=已出行 1=愿望清单
  wishlist_done INTEGER DEFAULT 0,
  plan_date TEXT,-- 计划出行日期
  record_date TEXT NOT NULL,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  is_deleted INTEGER DEFAULT 0
);

-- 行程主表（一次旅行）
CREATE TABLE trips (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,           -- 行程名称（如"成都之行"）
  start_date TEXT,
  end_date TEXT,
  destinations TEXT,            -- JSON数组：途经城市
  total_expense REAL,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
);

-- 目标实体（层级拆解）
CREATE TABLE goal_records (
  id TEXT PRIMARY KEY,
  parent_id TEXT,               -- 父目标ID（NULL=年度目标）
  level TEXT NOT NULL,          -- year/quarter/month/daily
  title TEXT NOT NULL,
  note TEXT,                    -- 备注（目标意义、执行计划）
  summary TEXT,                 -- 总结（完成情况、经验教训）
  category TEXT,                -- 职业/健康/旅行/美食/学习/社交/家庭
  progress REAL DEFAULT 0,      -- 0-100 进度
  is_completed INTEGER DEFAULT 0,
  is_postponed INTEGER DEFAULT 0,-- 是否顺延
  remind_frequency TEXT,        -- daily/weekly/monthly/none
  target_year INTEGER,
  target_quarter INTEGER,
  target_month INTEGER,
  due_date TEXT,
  record_date TEXT NOT NULL,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  is_deleted INTEGER DEFAULT 0
);

-- 朋友实体
CREATE TABLE friend_records (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  avatar_path TEXT,             -- 本地头像路径
  birthday TEXT,
  contact TEXT,                 -- 联系方式
  meet_way TEXT,                -- 认识途径
  meet_date TEXT,               -- 认识日期
  impression_tags TEXT,         -- JSON数组：印象标签
  group_name TEXT,              -- 分组（家人/闺蜜/同事）
  last_meet_date TEXT,          -- 上次见面时间
  contact_frequency TEXT,       -- 联络频率（3个月/6个月）
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  is_deleted INTEGER DEFAULT 0
);

-- 相遇记录
CREATE TABLE encounter_records (
  id TEXT PRIMARY KEY,
  friend_ids TEXT NOT NULL,     -- JSON数组：参与朋友ID列表
  event_summary TEXT,           -- 做了什么
  record_date TEXT NOT NULL,
  is_auto INTEGER DEFAULT 0,   -- 0=手动 1=自动生成
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
);
```

### 3.2 万物关联表（核心）

PRD 的"万物关联"要求所有实体可互联 [1]，用一张通用关联表实现：

```sql
-- 万物关联表
CREATE TABLE entity_links (
  id TEXT PRIMARY KEY,
  source_type TEXT NOT NULL,    -- food/moment/travel/goal/friend/encounter
  source_id TEXT NOT NULL,
  target_type TEXT NOT NULL,
  target_id TEXT NOT NULL,
  link_type TEXT DEFAULT 'manual', -- manual/auto
  created_at TEXT NOT NULL,
  UNIQUE(source_type, source_id, target_type, target_id)
);

-- 关联日志（PRD要求可追溯）
CREATE TABLE link_logs (
  id TEXT PRIMARY KEY,
  source_type TEXT NOT NULL,
  source_id TEXT NOT NULL,
  target_type TEXT NOT NULL,
  target_id TEXT NOT NULL,
  action TEXT NOT NULL,         -- create/delete
  link_type TEXT,-- manual/auto
  created_at TEXT NOT NULL
);
```

#### 3.2.1 当前代码实现对齐（已落地）

- 已在 Drift 中落地：`food_records`、`moment_records`、`friend_records`、`entity_links`、`link_logs`、`timeline_events`。
- 类型差异说明：设计稿 SQL 使用 `TEXT YYYY-MM-DD/ISO8601` 存时间；当前 Drift 实现统一用 `DateTime` 字段存储，查询范围用日期边界（start/endExclusive）表达。
- 迁移策略：当前 schemaVersion=2，v1→v2 增量迁移仅创建新增三实体表；首次安装直接 `createAll()` 一次建表。
- Link 的“增删查 + 追溯”：新增/删除会写入 `link_logs`，用于后续“关联可追溯”与审计展示。

### 3.3 搜索索引层（三层数据压缩）

```sql
-- 层2：索引文档（供本地检索 + embedding + AI上送）
CREATE TABLE search_docs (
  id TEXT PRIMARY KEY,
  entity_type TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  core_text TEXT NOT NULL,      -- 限200-500字的可检索摘要
  ocr_text TEXT,                -- 图片OCR提取文字
  media_tags TEXT,              -- 图片标签（JSON数组）
  metrics TEXT,                 -- 关键数值（JSON：评分/人均/情绪/花费等）
  people TEXT,                  -- 关联朋友名字列表
  city TEXT,
  tags TEXT,
  record_date TEXT NOT NULL,
  embedding BLOB,              -- 向量（可选，二期加）
  updated_at TEXT NOT NULL,
  UNIQUE(entity_type, entity_id)
);

-- 层3：极简摘要（供年度总结/那年今日快速展示）
CREATE TABLE mini_summaries (
  id TEXT PRIMARY KEY,
  entity_type TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  summary TEXT NOT NULL,        -- 50-120字极简摘要
  record_date TEXT NOT NULL,
  UNIQUE(entity_type, entity_id)
);

-- FTS5 全文检索虚拟表
CREATE VIRTUAL TABLE search_fts USING fts5(
  entity_type,
  entity_id,
  core_text,
  ocr_text,
  tags,
  people,
  city,
  content=search_docs,
  content_rowid=rowid
);
```

### 3.4 同步与变更追踪

```sql
-- 变更日志（WebDAV增量同步用）
CREATE TABLE change_log (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  entity_type TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  action TEXT NOT NULL,         -- insert/update/delete
  changed_fields TEXT,          -- JSON：变更的字段列表
  timestamp TEXT NOT NULL,
  synced INTEGER DEFAULT 0     -- 0=未同步 1=已同步
);

-- 同步状态
CREATE TABLE sync_state (
  id INTEGER PRIMARY KEY,
  last_sync_time TEXT,
  last_sync_change_id INTEGER,
  device_id TEXT
);
```

---

## 四、年度报告系统设计（核心重点）

这是整个方案最关键的部分。PRD 要求年度报告包含"年度大事记、年度味觉地图、年度旅行足迹、年度友谊报告、年度情绪总结、年度目标完成情况" [1]。

### 4.1 核心原则：SQL 算数，AI 写文

AI 擅长写漂亮的感悟，但不擅长数数。所有统计指标必须由 SQL 预先算好，以"确定性数字"的形式喂给 AI，AI 只负责"基于这些数字写出有温度的文案"。

### 4.2 年度报告生成管线（5 步流水线）

```
Step 1          Step 2           Step 3          Step 4          Step 5
本地SQL      →  本地SQL       →  分模块调AI   →  汇总调AI    →  本地渲染
算统计指标      提取模块素材       生成模块文案      生成总报告      排版PDF
(纯本地)        (纯本地)          (联网API)        (联网API)      (纯本地)
```

### 4.3 Step 1：SQL 预聚合统计指标（纯本地，不耗 token）

```sql
-- ========== 总览统计 ==========
SELECT
  (SELECT COUNT(*) FROM food_records WHERE strftime('%Y', record_date)='2024' AND is_deleted=0) as total_food,
  (SELECT COUNT(*) FROM moment_records WHERE strftime('%Y', record_date)='2024' AND is_deleted=0) as total_moments,
  (SELECT COUNT(*) FROM travel_records WHERE strftime('%Y', record_date)='2024' AND is_deleted=0 AND is_wishlist=0) as total_travel,
  (SELECT COUNT(*) FROM goal_records WHERE target_year=2024 AND is_deleted=0) as total_goals,
  (SELECT COUNT(*) FROM encounter_records WHERE strftime('%Y', record_date)='2024') as total_encounters;

-- ========== 美食模块统计 ==========
-- 年度味觉地图数据
SELECT city, COUNT(*) as visit_count, AVG(rating) as avg_rating, AVG(price_per_person) as avg_price
FROM food_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0 AND is_wishlist=0
GROUP BY city ORDER BY visit_count DESC;

-- TOP评分美食
SELECT title, rating, poi_name, city, record_date
FROM food_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0 AND is_wishlist=0
ORDER BY rating DESC LIMIT 10;

-- 复访最多的店
SELECT poi_name, COUNT(*) as revisit_count
FROM food_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0 AND poi_name IS NOT NULL
GROUP BY poi_name HAVING revisit_count > 1
ORDER BY revisit_count DESC LIMIT 5;

-- 月度美食频次
SELECT strftime('%m', record_date) as month, COUNT(*) as count
FROM food_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0
GROUP BY month;

-- 心愿达成率
SELECT
  (SELECT COUNT(*) FROM food_records WHERE strftime('%Y', record_date)='2024' AND is_wishlist=1 AND wishlist_done=1) as done,
  (SELECT COUNT(*) FROM food_records WHERE strftime('%Y', record_date)='2024' AND is_wishlist=1) as total;

-- ========== 情绪模块统计 ==========
-- 月度情绪分布
SELECT strftime('%m', record_date) as month, mood, COUNT(*) as count
FROM moment_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0
GROUP BY month, mood;

-- 年度情绪TOP5
SELECT mood, COUNT(*) as count
FROM moment_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0
GROUP BY mood ORDER BY count DESC LIMIT 5;

-- 场景分布
SELECT scene_tag, COUNT(*) as count
FROM moment_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0 AND scene_tag IS NOT NULL
GROUP BY scene_tag ORDER BY count DESC;

-- ========== 旅行模块统计 ==========
-- 足迹城市
SELECT DISTINCT city FROM travel_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0 AND is_wishlist=0 AND city IS NOT NULL;

-- 旅行花费汇总
SELECT t.name as trip_name, t.start_date, t.end_date,
  SUM(tr.expense_transport) as transport,
  SUM(tr.expense_hotel) as hotel,
  SUM(tr.expense_food) as food,
  SUM(tr.expense_ticket) as ticket,
  SUM(tr.expense_transport+tr.expense_hotel+tr.expense_food+tr.expense_ticket) as total
FROM trips t
JOIN travel_records tr ON tr.trip_id = t.id
WHERE strftime('%Y', t.start_date)='2024'
GROUP BY t.id;

-- ========== 目标模块统计 ==========
-- 年度目标完成率
SELECT category,
  COUNT(*) as total,
  SUM(CASE WHEN is_completed=1 THEN 1 ELSE 0 END) as completed,ROUND(AVG(progress), 1) as avg_progress
FROM goal_records
WHERE target_year=2024 AND level='year' AND is_deleted=0
GROUP BY category;

-- 顺延次数
SELECT COUNT(*) as postpone_count
FROM goal_records
WHERE target_year=2024 AND is_postponed=1 AND is_deleted=0;

-- ========== 羁绊模块统计 ==========
-- 互动频次TOP朋友
SELECT f.name, COUNT(el.id) as interaction_count
FROM friend_records f
JOIN entity_links el ON (el.target_type='friend' AND el.target_id=f.id)
  OR (el.source_type='friend' AND el.source_id=f.id)
WHERE f.is_deleted=0
GROUP BY f.id ORDER BY interaction_count DESC LIMIT 10;

-- 与朋友相处时的心情分布
SELECT f.name, m.mood, COUNT(*) as count
FROM friend_records f
JOIN entity_links el ON el.target_type='friend' AND el.target_id=f.id
JOIN moment_records m ON el.source_type='moment' AND el.source_id=m.id
WHERE strftime('%Y', m.record_date)='2024'
GROUP BY f.name, m.mood;

-- 新认识的朋友
SELECT name, meet_date, meet_way
FROM friend_records
WHERE strftime('%Y', meet_date)='2024' AND is_deleted=0;
```

### 4.4 Step 2：提取模块素材（纯本地）

对每个模块，从 `search_docs` 和 `mini_summaries` 表中提取该年度的素材：

```dart
// 伪代码：提取美食模块素材
Future<ModuleMaterial> extractFoodMaterial(int year) async {
  // 1. 拿到 Step1 的统计指标（已经是确定数字）
  final stats = await db.getFoodYearStats(year);

  // 2. 从 search_docs 提取 TOP 记录的 core_text（限量）
  final topRatedDocs = await db.getSearchDocs(
    entityType: 'food',
    year: year,
    orderBy: 'rating DESC',
    limit: 20,  // 只取TOP20的摘要
  );

  // 3. 从 mini_summaries 提取全量极简摘要（用于覆盖校验）
  final allMiniSummaries = await db.getMiniSummaries(
    entityType: 'food',
    year: year,
  );

  return ModuleMaterial(
    stats: stats,           // 确定性数字
    topDocs: topRatedDocs,  // TOP记录的200-500字摘要
    miniList: allMiniSummaries, // 全量50-120字极简摘要totalCount: allMiniSummaries.length, // 用于覆盖校验
  );
}
```

### 4.5 Step 3：分模块调 AI 生成文案（联网 API，分批迭代）

这是 token 消耗的主要环节。采用"分批迭代 + 覆盖校验"策略：

```
对每个模块（美食/小确幸/旅行/目标/羁绊）分别执行：┌──────────────────────────────────────────────────┐
  │  Prompt 第1部分：统计指标（SQL算好的，AI不需要数） │
  │  "以下是2024年美食模块的确定性统计数据：          │
  │   总记录数：156条                                 │
  │   覆盖城市：12个                                  │
  │   平均评分：4.2星                                 │
  │   TOP3城市：成都(38次)、北京(25次)、上海(20次)    │
  │   TOP3高分：XXX(5星)、YYY(4.8星)、ZZZ(4.8星)     │
  │   心愿达成率：8/15 = 53%                          │
  │   月度频次：1月12次、2月8次...12月18次             │
  │   复访最多：海底捞春熙路店(6次)                    │
  │   ⚠️ 以上数字已经过精确计算，请直接引用，不要修改" │
  └──────────────────────────────────────────────────┘+
  ┌──────────────────────────────────────────────────┐
  │  Prompt 第2部分：素材（分批上送 mini_summaries）   │
  │  "以下是本年度美食记录的摘要清单（第1批，共3批）：│
  │   [id:f001] 1月5日 成都·海底捞 和张三 评分4.5     │
  │   [id:f002] 1月12日 北京·寿司之神 一人食 评分5    │
  │   ... （每批50-80条极简摘要）                      │
  │   请基于以上统计数据和素材，输出：                  │
  │   1. running_summary：到目前为止的美食年度总结文案  │
  │   2. highlights：值得特别提及的记录ID列表           │
  │   3. covered_ids：本批处理过的记录ID列表"│
  └──────────────────────────────────────────────────┘
```

每批处理完后，本地做覆盖校验：

```dart
// 覆盖校验
Set<String> allIds = material.miniList.map((e) => e.id).toSet();
Set<String> coveredIds = {};

for (var batch in batches) {
  final response = await callAI(buildPrompt(stats, batch));
  coveredIds.addAll(response.coveredIds);
  runningSummary = response.runningSummary;
}

// 检查遗漏
Set<String> missed = allIds.difference(coveredIds);
if (missed.isNotEmpty) {
  // 补发遗漏的记录，让AI更新总结
  final missedItems = material.miniList.where((e) => missed.contains(e.id));
  final补充response = await callAI(buildSupplementPrompt(stats, runningSummary, missedItems));
  runningSummary = 补充response.runningSummary;
}
```

### 4.6 Step 4：汇总生成最终年度报告（联网 API，1次调用）

```
Prompt：
"你是人生编年史APP的年度报告撰写者。以下是2024年各模块的确定性统计和模块总结文案，
请生成一份完整的年度报告。

⚠️ 重要规则：
1. 所有数字必须直接引用下方提供的统计数据，不要自己计算或推测
2. 语气温暖、有温度，像写给未来自己的一封信
3. 输出格式为JSON，包含以下章节

== 总览统计（SQL精确值）==
全年总记录数：823条
美食：156条 | 小确幸：312条 | 旅行：89条 | 目标：45条 | 相遇：221次

== 美食模块总结 ==
{Step3生成的美食running_summary}

== 情绪模块总结 ==
{Step3生成的情绪running_summary}

== 旅行模块总结 ==
{Step3生成的旅行running_summary}

== 目标模块总结 ==
{Step3生成的目标running_summary}

== 羁绊模块总结 ==
{Step3生成的羁绊running_summary}

请输出：
{
  "opening": "年度开篇语（200字以内）",
  "food_chapter": "美食篇章（300-500字）",
  "emotion_chapter": "情绪篇章（300-500字）",
  "travel_chapter": "旅行篇章（300-500字）",
  "goal_chapter": "目标篇章（300-500字）",
  "friendship_chapter": "羁绊篇章（300-500字）",
  "closing": "年度结语（200字以内）",
  "keywords": ["年度关键词", "最多5个"]
}"
```

### 4.7 Step 5：本地渲染排版（纯本地，不耗 token）

```dart
// 用 dart_pdf 将 AI 文案 + SQL 统计 + 本地图表 组合排版
Future<File> renderAnnualReport(AnnualReportData data) async {
  final pdf = pw.Document();

  // 封面
  pdf.addPage(buildCoverPage(data.year, data.keywords));

  // 总览页（数据可视化：用 SQL 统计数据画图表）
  pdf.addPage(buildOverviewPage(data.stats));

  // 各模块章节（AI文案 + 本地图片 + 统计图表）
  pdf.addPage(buildFoodChapter(data.foodChapter, data.foodStats, data.tasteMapImage));
  pdf.addPage(buildEmotionChapter(data.emotionChapter, data.moodBubbleImage));
  pdf.addPage(buildTravelChapter(data.travelChapter, data.footprintMapImage));
  pdf.addPage(buildGoalChapter(data.goalChapter, data.goalProgressImage));
  pdf.addPage(buildFriendshipChapter(data.friendshipChapter, data.friendStats));

  // 结语
  pdf.addPage(buildClosingPage(data.closing));

  final file = File('${appDir}/exports/annual_report_${data.year}.pdf');
  await file.writeAsBytes(await pdf.save());
  return file;
}
```

---

## 五、智能搜索（RAG）系统设计

### 5.1 搜索管线（两段式）

```
用户输入自然语言
       │
       ▼
┌─────────────────────┐
│ Step A: 意图解析     │  ← 调1次AI API（很少token）
│ "去年夏天和张三吃的  │
│  日料叫什么"         │
│  → {                 │
│    date_range:       │
│      2023-06~2023-09,│
│    person: "张三",   │
│    module: "food",   │
│    keywords:         │
│      ["日料","日本料理│
│       ","寿司"]      │
│  }                   │
└─────────┬───────────┘
          ▼
┌─────────────────────┐
│ Step B: 本地SQL过滤  │  ← 纯本地，不耗token
│ WHERE record_date    │
│   BETWEEN ... AND ...│
│ AND entity has link  │
│   to friend "张三"   │
│ AND type = 'food'    │
└─────────┬───────────┘



设计系统（让 UI 风格统一，不要每页硬编码）
输出这些“设计 token”（让 AI 引用常量，不要自由发挥）

---

## 六、前端原型复刻（当前实现进度）

本阶段目标：先把安卓应用的“主页 + 新建（含部分详情）”界面骨架搭起来，确保 6 个底部菜单布局固定不变，并为后续逐页逐像素复刻提供落点。

### 6.1 入口与导航

- 应用入口：使用 [app.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/app/app.dart) 挂载 [app_shell.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/app/app_shell.dart)，通过 IndexedStack 固定 6 个 Tab。
- 首页日程：顶部 “AI史官” 按钮跳转 AI 史官聊天页；右侧 “设置” 跳转个人中心：[home_schedule_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/home_schedule/presentation/home_schedule_page.dart)

### 6.2 页面落点（feature-first）

- AI 史官聊天页（原型：AI 史官对话）：[ai_historian_chat_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/ai_historian/presentation/ai_historian_chat_page.dart)
  - 顶部玻璃栏：返回、在线状态、分析/清空入口
  - 会话区：时间戳、AI/用户气泡、推荐卡片
  - 底部输入：快捷指令 Chips + 输入框 + 发送按钮
- 个人中心（原型：个人中心/功能管理入口）：[profile_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/profile/presentation/profile_page.dart)
  - 人生传记卡片与“生成编年史”入口（先以占位页承接）
  - 收藏/编年史管理/年度报告/数据管理/模块管理等入口（先以占位页承接）
- 美食（原型：美食主页/新建/详情）：[food_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/food/presentation/food_page.dart)
  - 主页：搜索栏、筛选按钮、分段切换（美食记录/心愿清单）、筛选 Chips、味觉地图块、双列卡片瀑布流
  - 新建：添加照片、餐厅信息、标签、万物互联入口、记录输入
  - 详情：封面图、基础信息、万物互联块、记录内容、底部操作栏（心愿清单详情页也在同一落点承接）
- 小确幸（原型：小确幸主页/新建/详情）：[moment_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/moment/presentation/moment_page.dart)
  - 主页：搜索栏、筛选/新增按钮、心情分类 Chips、双列卡片瀑布流
  - 新建：添加照片、心情选择、记录输入、万物互联占位
  - 详情：图片 + 心情标签 + 文本内容 + 万物互联占位
- 旅行（原型：旅行主页/新建/详情）：[travel_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/travel/presentation/travel_page.dart)
  - 主页：搜索栏、筛选/新增按钮、头部信息卡、旅程记录列表、足迹地图块
  - 新建行程（对应原型：`4-3 旅行-新建旅行行程`）：玻璃拟态顶部栏（取消/标题/创建）、封面上传虚线框、标题/备注输入、基本信息分组（目的地/日期范围/预算）、同行者横向邀请区、规划详情（愿望清单开关/预订链接/心愿清单勾选与新增）
  - 行程详情（对应原型：`4-2 旅行-在路上-旅行行程详情`）：头图 Hero + 渐变遮罩 + 底部圆角、玻璃拟态按钮组（返回/收藏/编辑/新增）与“一键导出”、行程信息浮层（天数/地点/标题/日期）、时间线布局（连续竖线 + Day 区块 + 记忆卡/相册卡/美食卡/同行者卡）
  - 新建游记（对应原型：`4-4 旅行-旅行行程-新建旅行游记`）：玻璃拟态顶部栏（取消/发布）、标题/正文输入、九宫格图片区（含虚线“添加照片”格）、地点/心情/同行/关联美食/标签等关联区块与“正在关联行程”提示胶囊
  - 交互承接：行程详情页顶部“编辑”→新建行程页（作为编辑承接）；顶部“+”与悬浮“+”→新建游记页
  - 复刻辅助：在同一落点内实现虚线圆角边框（用于封面上传框与九宫格添加格），并使用 BackdropFilter 复刻玻璃拟态顶部栏/按钮背景
  - 布局约束：在 CustomScrollView 的 SliverToBoxAdapter 里避免依赖“无限高度”的 Stack/自绘容器；时间线竖线改为基于子内容尺寸绘制、头像叠放区域显式给宽度，确保测试与真实运行一致（`flutter test` 不再出现 `RenderBox was not laid out`）。
- 目标（原型：目标看板/新建/详情）：[goal_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/goal/presentation/goal_page.dart)
  - 主页：目标看板头部卡、进行中目标进度条列表、已完成块
  - 新建：标题/分类/截止时间/描述输入、万物互联占位
  - 详情：目标拆解详情页（圆环进度 Hero、季度树结构、月度目标与每日任务、关联记忆横滑区、底部操作栏“顺延计划/阶段复盘”）
- 羁绊（原型：朋友档案/相遇）：[bond_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/bond/presentation/bond_page.dart)
  - 顶部：标题 + “解析” + 分段切换（朋友档案/相遇）+ 搜索/筛选/新增
  - 朋友档案：双列瀑布流卡片（头像、标签、相识时长、上次见面）
  - 相遇：时间线样式卡片（日期、标题、摘要、参与头像与“+N 位伙伴”）
  - 朋友档案详情：档案卡（头像/认识天数/基础信息/标签/操作按钮）+ AI 洞察入口 + 共同回忆轴（筛选 Pills + 时间线卡片）
  - 相遇新建/详情：从顶部“+”或悬浮“+”进入新建相遇；相遇卡片进入详情页（参与者 + 记录 + 万物互联占位）
- UI 兼容性约定：当前 Flutter SDK 下颜色透明度统一使用 `Color.withValues(alpha: ...)`，避免 `withOpacity` 的废弃告警影响 `flutter analyze` 基线。
