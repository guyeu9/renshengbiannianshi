# 人生编年史 APP 完整开发设计方案

---

## 一、技术架构总览

```
┌─────────────────────────────────────────────────────────┐
│                    Flutter 客户端                         │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌─────────┐ │
│  │  UI 层     │ │ 状态管理   │ │ 本地AI管线 │ │ 同步引擎 │ │
│  │ (Widgets)  │ │ (Riverpod)│ │ (Pipeline) │ │(WebDAV) │ │
│  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └────┬────┘ │
│        └──────────────┴─────────────┴────────────┘      │
│                         │                                │
│              ┌──────────┴──────────┐                     │
│              │   Drift (SQLite)    │                     │
│              │  + FTS5 + SQLCipher │                     │
│              └─────────────────────┘                     │
│                         │                                │
│              ┌──────────┴──────────┐                     │
│              │  本地文件系统        │                     │
│              │  图片/视频/导出文件   │                     │
│              └─────────────────────┘                     │
└─────────────────────────────────────────────────────────┘
                │
            ┌─────────────┴─────────────┐
            │    联网 API（仅 AI 调用）    │
            │  DeepSeek / 通义千问 / Claude │
            └───────────────────────────┘
```

核心原则：**数据全部在本地**，没有自建后端，没有云数据库。联网只做两件事：调 AI 大模型 API、调 Embedding API。同步只走 WebDAV 网盘（如坚果云）[1]。

---

## 二、技术选型清单

| 层级 | 选型 | 理由 |
|---|---|---|
| 跨端框架 | Flutter 3.x (Dart) | 一套代码先出 Android 后出 iOS；自绘引擎对 PRD 要求的大量动效（彩带、气泡、涟漪、骨架屏）实现成本最低 [1] |
| 状态管理 | Riverpod | 模块多、实体关联复杂，Riverpod 的 Provider 依赖树比 Bloc 更适合"万物互联"的数据流 |
| 本地数据库 | Drift (SQLite) + FTS5 | 关系型结构完美匹配 PRD 的六大实体关联模型 [1]；FTS5 提供全文检索能力 |
| 本地加密 | SQLCipher + Keystore/Keychain | PRD 要求"加密备份" [1]，数据库层面加密最彻底 |
| 地图 SDK | 高德地图 Flutter 插件 | 国内场景，味觉地图 + 旅行足迹地图 [1] |
| PDF 导出 | dart_pdf + printing | 人生传记 PDF、年度味觉地图长图、行程导出 [1] |
| EPUB 导出 | epubx (Dart) | 人生传记 EPUB 格式 [1] |
| 图片 OCR | Google ML Kit (离线) | 本地识别菜单/票据/招牌文字，不上传图片 |
| 图片标签 | Google ML Kit Image Labeling | 本地输出"海滩/寿司/咖啡"等标签 |
| EXIF 提取 | exif (Dart package) | 提取拍摄时间、经纬度、设备信息 |
| WebDAV 同步 | webdav_client (Dart) | 增量备份到坚果云等网盘 [1] |
| AI 大模型 | DeepSeek / 通义千问 API | 联网调用，用于意图解析、情绪总结、社交洞察、年度报告文案生成 |
| Embedding | bge-m3 API 或 text-embedding-3 | 联网调用，为记录生成向量，存本地做语义检索 |
| 本地向量存储 | SQLite BLOB 字段 | 向量存本地，查询时 Dart 侧做余弦相似度计算 |

### 2.x Windows 本地开发环境（Flutter）

- Flutter SDK：放置在 `_toolchain/flutter`，并设置国内镜像环境变量：
  - `PUB_HOSTED_URL=https://pub.flutter-io.cn`
  - `FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn`
- 关键前置条件（Windows 桌面）：需要启用系统“开发者模式”或使用管理员权限运行终端，否则无法创建符号链接，包含插件的 `flutter pub get / flutter run` 会失败（Flutter 会提示 “Building with plugins requires symlink support.”）。
- 编译级验证基线：当前仓库以 `flutter analyze` + `flutter test` 作为最小可重复验证；网络图片会在测试中使用 HttpClient 桩，避免测试运行时的网络依赖。
- 构建验证基线：当前环境已通过 `flutter build web`，可用于持续集成的首个稳定目标；Windows 桌面构建仍依赖本机安装 Visual Studio（Desktop development with C++）。
- CI 构建基线：仓库新增 GitHub Actions 流水线用于输出 Android APK，见 `.github/workflows/android-apk.yml`。
- Android 包名：`applicationId/namespace` 统一为 `com.suliuzhe.lifechronicle`。

---

## 三、数据库设计（Drift/SQLite）

### 3.1 六大核心实体表

PRD 定义了六大关联实体 [1]，数据库按以下结构设计：

```sql
-- 美食实体
CREATE TABLE food_records (
  id TEXT PRIMARY KEY,          -- UUID
  title TEXT NOT NULL,          -- 店名/菜名
  content TEXT,                 -- 详细描述
  images TEXT,                  -- JSON数组：本地图片路径列表
  tags TEXT,                    -- JSON数组：标签列表
  rating REAL,                  -- 1-5星评分
  price_per_person REAL,        -- 人均消费
  link TEXT,                    -- 超链接
  latitude REAL,                -- 纬度
  longitude REAL,               -- 经度
  poi_name TEXT,                -- POI名称（如"海底捞春熙路店"）
  city TEXT,                    -- 城市
  mood TEXT,                    -- 关联心情
  is_wishlist INTEGER DEFAULT 0,-- 0=已品尝 1=心愿清单
  is_favorite INTEGER DEFAULT 0,-- 0=未收藏 1=收藏
  wishlist_done INTEGER DEFAULT 0,
  record_date TEXT NOT NULL,    -- 记录日期 YYYY-MM-DD
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  is_deleted INTEGER DEFAULT 0  -- 软删除
);

-- 小确幸实体
CREATE TABLE moment_records (
  id TEXT PRIMARY KEY,
  content TEXT,
  images TEXT,                  -- JSON数组
  mood TEXT NOT NULL,           -- 心情标签
  mood_color TEXT,              -- 心情对应颜色
  scene_tag TEXT,               -- 场景标签（居家/读书/电影/户外）
  latitude REAL,
  longitude REAL,
  city TEXT,
  is_favorite INTEGER DEFAULT 0,
  record_date TEXT NOT NULL,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  is_deleted INTEGER DEFAULT 0
);

-- 旅行实体
CREATE TABLE travel_records (
  id TEXT PRIMARY KEY,
  trip_id TEXT NOT NULL,        -- 所属行程ID（一次旅行多条记录）
  title TEXT,
  content TEXT,
  images TEXT,
  destination TEXT,             -- 目的地
  latitude REAL,
  longitude REAL,
  city TEXT,
  mood TEXT,
  expense_transport REAL,       -- 交通花费
  expense_hotel REAL,           -- 住宿花费
  expense_food REAL,            -- 美食花费
  expense_ticket REAL,          -- 景点花费
  is_wishlist INTEGER DEFAULT 0,-- 0=已出行 1=愿望清单
  is_favorite INTEGER DEFAULT 0,-- 0=未收藏 1=收藏
  wishlist_done INTEGER DEFAULT 0,
  plan_date TEXT,-- 计划出行日期
  record_date TEXT NOT NULL,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  is_deleted INTEGER DEFAULT 0
);

-- 行程主表（一次旅行）
CREATE TABLE trips (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,           -- 行程名称（如"成都之行"）
  start_date TEXT,
  end_date TEXT,
  destinations TEXT,            -- JSON数组：途经城市
  total_expense REAL,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
);

-- 目标实体（层级拆解）
CREATE TABLE goal_records (
  id TEXT PRIMARY KEY,
  parent_id TEXT,               -- 父目标ID（NULL=年度目标）
  level TEXT NOT NULL,          -- year/quarter/month/daily
  title TEXT NOT NULL,
  note TEXT,                    -- 备注（目标意义、执行计划）
  summary TEXT,                 -- 总结（完成情况、经验教训）
  category TEXT,                -- 职业/健康/旅行/美食/学习/社交/家庭
  progress REAL DEFAULT 0,      -- 0-100 进度
  is_completed INTEGER DEFAULT 0,
  is_postponed INTEGER DEFAULT 0,-- 是否顺延
  remind_frequency TEXT,        -- daily/weekly/monthly/none
  target_year INTEGER,
  target_quarter INTEGER,
  target_month INTEGER,
  due_date TEXT,
  record_date TEXT NOT NULL,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  is_deleted INTEGER DEFAULT 0
);

-- 朋友实体
CREATE TABLE friend_records (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  avatar_path TEXT,             -- 本地头像路径
  birthday TEXT,
  contact TEXT,                 -- 联系方式
  meet_way TEXT,                -- 认识途径
  meet_date TEXT,               -- 认识日期
  impression_tags TEXT,         -- JSON数组：印象标签
  group_name TEXT,              -- 分组（家人/闺蜜/同事）
  last_meet_date TEXT,          -- 上次见面时间
  contact_frequency TEXT,       -- 联络频率（3个月/6个月）
  is_favorite INTEGER DEFAULT 0,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  is_deleted INTEGER DEFAULT 0
);

-- 相遇记录
CREATE TABLE encounter_records (
  id TEXT PRIMARY KEY,
  friend_ids TEXT NOT NULL,     -- JSON数组：参与朋友ID列表
  event_summary TEXT,           -- 做了什么
  record_date TEXT NOT NULL,
  is_auto INTEGER DEFAULT 0,   -- 0=手动 1=自动生成
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
);
```

### 3.2 万物互联表（核心）

PRD 的"万物互联"要求所有实体可互联 [1]，用一张通用关联表实现：

```sql
-- 万物互联表
CREATE TABLE entity_links (
  id TEXT PRIMARY KEY,
  source_type TEXT NOT NULL,    -- food/moment/travel/goal/friend/encounter
  source_id TEXT NOT NULL,
  target_type TEXT NOT NULL,
  target_id TEXT NOT NULL,
  link_type TEXT DEFAULT 'manual', -- manual/auto
  created_at TEXT NOT NULL,
  UNIQUE(source_type, source_id, target_type, target_id)
);

-- 关联日志（PRD要求可追溯）
CREATE TABLE link_logs (
  id TEXT PRIMARY KEY,
  source_type TEXT NOT NULL,
  source_id TEXT NOT NULL,
  target_type TEXT NOT NULL,
  target_id TEXT NOT NULL,
  action TEXT NOT NULL,         -- create/delete
  link_type TEXT,-- manual/auto
  created_at TEXT NOT NULL
);
```

#### 3.2.1 当前代码实现对齐（已落地）

- 已在 Drift 中落地：`food_records`、`moment_records`、`friend_records`、`travel_records`、`trips`、`entity_links`、`link_logs`、`timeline_events`、`user_profiles`。
- 相遇（encounter）当前落地策略：未引入 `encounter_records` 表；新建相遇写入 `timeline_events`（`eventType='encounter'`），并通过 `entity_links` 记录与朋友/美食等实体的关联。相遇 Tab 列表使用 `watchEncounterEvents` 直接读取 `timeline_events`；朋友档案“共同回忆轴”场景使用 `watchEncountersForFriend` 通过 `entity_links` 反查。
- 地点字段策略：统一使用高德地点组件采集 `poiName/poiAddress/latitude/longitude`；落库到实体表（food/moment/travel）与 `timeline_events`（moment/encounter/travel）。UI 展示/地图预览优先读结构化字段；`note` 中的“地点：...”仅作为历史数据兼容。
- 地点编辑一致性：移除遗留的“长按弹窗手动填写地点名称/地址”入口，所有模块地点编辑统一收敛到高德地点组件内的“搜索/手动填写/外部导航”能力，避免多套交互分叉导致字段不一致。
- 旅行（travel）日程落地策略：新建旅行写入 `travel_records` 的同时，同步 upsert `timeline_events(eventType='travel')`，用于首页日程按日期聚合展示。
- 图片持久化策略：统一使用 `persistImageFiles` 全局工具方法（`lib/core/utils/media_storage.dart`），将图片复制到应用沙盒 `Documents/media/{module}`（food/moment/travel/encounter），文件名格式 `{module}_{timestamp}_{index}.jpg`，数据库仅存本地路径；个人中心头像存 `Documents/profile` 并写入 `avatar.json` 供跨模块读取。此策略确保图片不受系统缓存清理影响。
- 个人资料策略：用户名/出生日期/身高体重/感情状态落库到 Drift 新表 `user_profiles`（固定一行 `id='me'`），字段包含 `display_name/birthday/height_cm/weight_kg/relationship_status/created_at/updated_at`；通过全局 provider 给个人中心头部与首页日程顶部栏统一展示。
- 相遇图片存储策略：相遇图片路径列表以 JSON 写入 `timeline_events.note` 的“图片”字段行（不新增表字段）。
- 小确幸（moment）字段映射策略：表结构无 `title` 字段，UI 的“标题 + 正文”会合并写入 `moment_records.content`（第一行标题，后续为正文）；标签写入 `scene_tag`，地理位置写入 `city`，心情写入 `mood`，颜色写入 `mood_color`（ARGB 十六进制字符串）。
- 数据库连接策略：AppDatabase 通过条件导入区分 Web 与本地运行时的数据库连接（Web 使用 `WebDatabase`，Android/iOS/桌面使用 `NativeDatabase`），仅解决平台差异与 Web 预览空白问题，表结构与关联逻辑完全一致。
- 关联日志检视：个人中心新增“万物互联”页用于展示 `link_logs`（最近日志 + 全部日志），用于验证各模块是否正确写入关联。
- 类型差异说明：设计稿 SQL 使用 `TEXT YYYY-MM-DD/ISO8601` 存时间；当前 Drift 实现统一用 `DateTime` 字段存储，查询范围用日期边界（start/endExclusive）表达。
- Link 的“增删查 + 追溯”：新增/删除会写入 `link_logs`，用于后续“关联可追溯”与审计展示。

#### 3.2.2 数据库迁移策略 (v6)

- **版本升级**：Schema Version 升级至 6。
- **文件路径**：统一使用 `life_chronicle.sqlite`，移除对旧文件名（`life_chronicle.db`, `app.db` 等）的兼容查找代码，确保单一数据源。
- **字段补全**：`onUpgrade` 逻辑中包含幂等的 `ensureTable` 和 `ensureColumn` 检查，确保以下表包含位置字段：
  - `FoodRecords`: `poiName`, `poiAddress`
  - `MomentRecords`: `poiName`, `poiAddress`, `latitude`, `longitude`
  - `TravelRecords`: `poiName`, `poiAddress`, `latitude`, `longitude`
  - `TimelineEvents`: `poiName`, `poiAddress`, `latitude`, `longitude`

#### 3.2.3 数据库迁移策略 (v7)

- **版本升级**：Schema Version 升级至 7。
- **新增表**：新增 `user_profiles` 表用于个人资料持久化（单行 `id='me'`），避免散落在文件系统 JSON 里导致多端/多页读取策略不一致。

### 3.3 搜索索引层（三层数据压缩）

```sql
-- 层2：索引文档（供本地检索 + embedding + AI上送）
CREATE TABLE search_docs (
  id TEXT PRIMARY KEY,
  entity_type TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  core_text TEXT NOT NULL,      -- 限200-500字的可检索摘要
  ocr_text TEXT,                -- 图片OCR提取文字
  media_tags TEXT,              -- 图片标签（JSON数组）
  metrics TEXT,                 -- 关键数值（JSON：评分/人均/情绪/花费等）
  people TEXT,                  -- 关联朋友名字列表
  city TEXT,
  tags TEXT,
  record_date TEXT NOT NULL,
  embedding BLOB,              -- 向量（可选，二期加）
  updated_at TEXT NOT NULL,
  UNIQUE(entity_type, entity_id)
);

-- 层3：极简摘要（供年度总结/那年今日快速展示）
CREATE TABLE mini_summaries (
  id TEXT PRIMARY KEY,
  entity_type TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  summary TEXT NOT NULL,        -- 50-120字极简摘要
  record_date TEXT NOT NULL,
  UNIQUE(entity_type, entity_id)
);

-- FTS5 全文检索虚拟表
CREATE VIRTUAL TABLE search_fts USING fts5(
  entity_type,
  entity_id,
  core_text,
  ocr_text,
  tags,
  people,
  city,
  content=search_docs,
  content_rowid=rowid
);
```

### 3.4 同步与变更追踪

```sql
-- 变更日志（WebDAV增量同步用）
CREATE TABLE change_log (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  entity_type TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  action TEXT NOT NULL,         -- insert/update/delete
  changed_fields TEXT,          -- JSON：变更的字段列表
  timestamp TEXT NOT NULL,
  synced INTEGER DEFAULT 0     -- 0=未同步 1=已同步
);

-- 同步状态
CREATE TABLE sync_state (
  id INTEGER PRIMARY KEY,
  last_sync_time TEXT,
  last_sync_change_id INTEGER,
  device_id TEXT
);
```

---

## 四、年度报告系统设计（核心重点）

这是整个方案最关键的部分。PRD 要求年度报告包含"年度大事记、年度味觉地图、年度旅行足迹、年度友谊报告、年度情绪总结、年度目标完成情况" [1]。

### 4.1 核心原则：SQL 算数，AI 写文

AI 擅长写漂亮的感悟，但不擅长数数。所有统计指标必须由 SQL 预先算好，以"确定性数字"的形式喂给 AI，AI 只负责"基于这些数字写出有温度的文案"。

### 4.2 年度报告生成管线（5 步流水线）

```
Step 1          Step 2           Step 3          Step 4          Step 5
本地SQL      →  本地SQL       →  分模块调AI   →  汇总调AI    →  本地渲染
算统计指标      提取模块素材       生成模块文案      生成总报告      排版PDF
(纯本地)        (纯本地)          (联网API)        (联网API)      (纯本地)
```

### 4.3 Step 1：SQL 预聚合统计指标（纯本地，不耗 token）

```sql
-- ========== 总览统计 ==========
SELECT
  (SELECT COUNT(*) FROM food_records WHERE strftime('%Y', record_date)='2024' AND is_deleted=0) as total_food,
  (SELECT COUNT(*) FROM moment_records WHERE strftime('%Y', record_date)='2024' AND is_deleted=0) as total_moments,
  (SELECT COUNT(*) FROM travel_records WHERE strftime('%Y', record_date)='2024' AND is_deleted=0 AND is_wishlist=0) as total_travel,
  (SELECT COUNT(*) FROM goal_records WHERE target_year=2024 AND is_deleted=0) as total_goals,
  (SELECT COUNT(*) FROM encounter_records WHERE strftime('%Y', record_date)='2024') as total_encounters;

-- ========== 美食模块统计 ==========
-- 年度味觉地图数据
SELECT city, COUNT(*) as visit_count, AVG(rating) as avg_rating, AVG(price_per_person) as avg_price
FROM food_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0 AND is_wishlist=0
GROUP BY city ORDER BY visit_count DESC;

-- TOP评分美食
SELECT title, rating, poi_name, city, record_date
FROM food_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0 AND is_wishlist=0
ORDER BY rating DESC LIMIT 10;

-- 复访最多的店
SELECT poi_name, COUNT(*) as revisit_count
FROM food_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0 AND poi_name IS NOT NULL
GROUP BY poi_name HAVING revisit_count > 1
ORDER BY revisit_count DESC LIMIT 5;

-- 月度美食频次
SELECT strftime('%m', record_date) as month, COUNT(*) as count
FROM food_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0
GROUP BY month;

-- 心愿达成率
SELECT
  (SELECT COUNT(*) FROM food_records WHERE strftime('%Y', record_date)='2024' AND is_wishlist=1 AND wishlist_done=1) as done,
  (SELECT COUNT(*) FROM food_records WHERE strftime('%Y', record_date)='2024' AND is_wishlist=1) as total;

-- ========== 情绪模块统计 ==========
-- 月度情绪分布
SELECT strftime('%m', record_date) as month, mood, COUNT(*) as count
FROM moment_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0
GROUP BY month, mood;

-- 年度情绪TOP5
SELECT mood, COUNT(*) as count
FROM moment_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0
GROUP BY mood ORDER BY count DESC LIMIT 5;

-- 场景分布
SELECT scene_tag, COUNT(*) as count
FROM moment_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0 AND scene_tag IS NOT NULL
GROUP BY scene_tag ORDER BY count DESC;

-- ========== 旅行模块统计 ==========
-- 足迹城市
SELECT DISTINCT city FROM travel_records
WHERE strftime('%Y', record_date)='2024' AND is_deleted=0 AND is_wishlist=0 AND city IS NOT NULL;

-- 旅行花费汇总
SELECT t.name as trip_name, t.start_date, t.end_date,
  SUM(tr.expense_transport) as transport,
  SUM(tr.expense_hotel) as hotel,
  SUM(tr.expense_food) as food,
  SUM(tr.expense_ticket) as ticket,
  SUM(tr.expense_transport+tr.expense_hotel+tr.expense_food+tr.expense_ticket) as total
FROM trips t
JOIN travel_records tr ON tr.trip_id = t.id
WHERE strftime('%Y', t.start_date)='2024'
GROUP BY t.id;

-- ========== 目标模块统计 ==========
-- 年度目标完成率
SELECT category,
  COUNT(*) as total,
  SUM(CASE WHEN is_completed=1 THEN 1 ELSE 0 END) as completed,ROUND(AVG(progress), 1) as avg_progress
FROM goal_records
WHERE target_year=2024 AND level='year' AND is_deleted=0
GROUP BY category;

-- 顺延次数
SELECT COUNT(*) as postpone_count
FROM goal_records
WHERE target_year=2024 AND is_postponed=1 AND is_deleted=0;

-- ========== 羁绊模块统计 ==========
-- 互动频次TOP朋友
SELECT f.name, COUNT(el.id) as interaction_count
FROM friend_records f
JOIN entity_links el ON (el.target_type='friend' AND el.target_id=f.id)
  OR (el.source_type='friend' AND el.source_id=f.id)
WHERE f.is_deleted=0
GROUP BY f.id ORDER BY interaction_count DESC LIMIT 10;

-- 与朋友相处时的心情分布
SELECT f.name, m.mood, COUNT(*) as count
FROM friend_records f
JOIN entity_links el ON el.target_type='friend' AND el.target_id=f.id
JOIN moment_records m ON el.source_type='moment' AND el.source_id=m.id
WHERE strftime('%Y', m.record_date)='2024'
GROUP BY f.name, m.mood;

-- 新认识的朋友
SELECT name, meet_date, meet_way
FROM friend_records
WHERE strftime('%Y', meet_date)='2024' AND is_deleted=0;
```

### 4.4 Step 2：提取模块素材（纯本地）

对每个模块，从 `search_docs` 和 `mini_summaries` 表中提取该年度的素材：

```dart
// 伪代码：提取美食模块素材
Future<ModuleMaterial> extractFoodMaterial(int year) async {
  // 1. 拿到 Step1 的统计指标（已经是确定数字）
  final stats = await db.getFoodYearStats(year);

  // 2. 从 search_docs 提取 TOP 记录的 core_text（限量）
  final topRatedDocs = await db.getSearchDocs(
    entityType: 'food',
    year: year,
    orderBy: 'rating DESC',
    limit: 20,  // 只取TOP20的摘要
  );

  // 3. 从 mini_summaries 提取全量极简摘要（用于覆盖校验）
  final allMiniSummaries = await db.getMiniSummaries(
    entityType: 'food',
    year: year,
  );

  return ModuleMaterial(
    stats: stats,           // 确定性数字
    topDocs: topRatedDocs,  // TOP记录的200-500字摘要
    miniList: allMiniSummaries, // 全量50-120字极简摘要totalCount: allMiniSummaries.length, // 用于覆盖校验
  );
}
```

### 4.5 Step 3：分模块调 AI 生成文案（联网 API，分批迭代）

这是 token 消耗的主要环节。采用"分批迭代 + 覆盖校验"策略：

```
对每个模块（美食/小确幸/旅行/目标/羁绊）分别执行：┌──────────────────────────────────────────────────┐
  │  Prompt 第1部分：统计指标（SQL算好的，AI不需要数） │
  │  "以下是2024年美食模块的确定性统计数据：          │
  │   总记录数：156条                                 │
  │   覆盖城市：12个                                  │
  │   平均评分：4.2星                                 │
  │   TOP3城市：成都(38次)、北京(25次)、上海(20次)    │
  │   TOP3高分：XXX(5星)、YYY(4.8星)、ZZZ(4.8星)     │
  │   心愿达成率：8/15 = 53%                          │
  │   月度频次：1月12次、2月8次...12月18次             │
  │   复访最多：海底捞春熙路店(6次)                    │
  │   ⚠️ 以上数字已经过精确计算，请直接引用，不要修改" │
  └──────────────────────────────────────────────────┘+
  ┌──────────────────────────────────────────────────┐
  │  Prompt 第2部分：素材（分批上送 mini_summaries）   │
  │  "以下是本年度美食记录的摘要清单（第1批，共3批）：│
  │   [id:f001] 1月5日 成都·海底捞 和张三 评分4.5     │
  │   [id:f002] 1月12日 北京·寿司之神 一人食 评分5    │
  │   ... （每批50-80条极简摘要）                      │
  │   请基于以上统计数据和素材，输出：                  │
  │   1. running_summary：到目前为止的美食年度总结文案  │
  │   2. highlights：值得特别提及的记录ID列表           │
  │   3. covered_ids：本批处理过的记录ID列表"│
  └──────────────────────────────────────────────────┘
```

每批处理完后，本地做覆盖校验：

```dart
// 覆盖校验
Set<String> allIds = material.miniList.map((e) => e.id).toSet();
Set<String> coveredIds = {};

for (var batch in batches) {
  final response = await callAI(buildPrompt(stats, batch));
  coveredIds.addAll(response.coveredIds);
  runningSummary = response.runningSummary;
}

// 检查遗漏
Set<String> missed = allIds.difference(coveredIds);
if (missed.isNotEmpty) {
  // 补发遗漏的记录，让AI更新总结
  final missedItems = material.miniList.where((e) => missed.contains(e.id));
  final补充response = await callAI(buildSupplementPrompt(stats, runningSummary, missedItems));
  runningSummary = 补充response.runningSummary;
}
```

### 4.6 Step 4：汇总生成最终年度报告（联网 API，1次调用）

```
Prompt：
"你是人生编年史APP的年度报告撰写者。以下是2024年各模块的确定性统计和模块总结文案，
请生成一份完整的年度报告。

⚠️ 重要规则：
1. 所有数字必须直接引用下方提供的统计数据，不要自己计算或推测
2. 语气温暖、有温度，像写给未来自己的一封信
3. 输出格式为JSON，包含以下章节

== 总览统计（SQL精确值）==
全年总记录数：823条
美食：156条 | 小确幸：312条 | 旅行：89条 | 目标：45条 | 相遇：221次

== 美食模块总结 ==
{Step3生成的美食running_summary}

== 情绪模块总结 ==
{Step3生成的情绪running_summary}

== 旅行模块总结 ==
{Step3生成的旅行running_summary}

== 目标模块总结 ==
{Step3生成的目标running_summary}

== 羁绊模块总结 ==
{Step3生成的羁绊running_summary}

请输出：
{
  "opening": "年度开篇语（200字以内）",
  "food_chapter": "美食篇章（300-500字）",
  "emotion_chapter": "情绪篇章（300-500字）",
  "travel_chapter": "旅行篇章（300-500字）",
  "goal_chapter": "目标篇章（300-500字）",
  "friendship_chapter": "羁绊篇章（300-500字）",
  "closing": "年度结语（200字以内）",
  "keywords": ["年度关键词", "最多5个"]
}"
```

### 4.7 Step 5：本地渲染排版（纯本地，不耗 token）

```dart
// 用 dart_pdf 将 AI 文案 + SQL 统计 + 本地图表 组合排版
Future<File> renderAnnualReport(AnnualReportData data) async {
  final pdf = pw.Document();

  // 封面
  pdf.addPage(buildCoverPage(data.year, data.keywords));

  // 总览页（数据可视化：用 SQL 统计数据画图表）
  pdf.addPage(buildOverviewPage(data.stats));

  // 各模块章节（AI文案 + 本地图片 + 统计图表）
  pdf.addPage(buildFoodChapter(data.foodChapter, data.foodStats, data.tasteMapImage));
  pdf.addPage(buildEmotionChapter(data.emotionChapter, data.moodBubbleImage));
  pdf.addPage(buildTravelChapter(data.travelChapter, data.footprintMapImage));
  pdf.addPage(buildGoalChapter(data.goalChapter, data.goalProgressImage));
  pdf.addPage(buildFriendshipChapter(data.friendshipChapter, data.friendStats));

  // 结语
  pdf.addPage(buildClosingPage(data.closing));

  final file = File('${appDir}/exports/annual_report_${data.year}.pdf');
  await file.writeAsBytes(await pdf.save());
  return file;
}
```

---

## 五、智能搜索（RAG）系统设计

### 5.1 搜索管线（两段式）

```
用户输入自然语言
       │
       ▼
┌─────────────────────┐
│ Step A: 意图解析     │  ← 调1次AI API（很少token）
│ "去年夏天和张三吃的  │
│  日料叫什么"         │
│  → {                 │
│    date_range:       │
│      2023-06~2023-09,│
│    person: "张三",   │
│    module: "food",   │
│    keywords:         │
│      ["日料","日本料理│
│       ","寿司"]      │
│  }                   │
└─────────┬───────────┘
          ▼
┌─────────────────────┐
│ Step B: 本地SQL过滤  │  ← 纯本地，不耗token
│ WHERE record_date    │
│   BETWEEN ... AND ...│
│ AND entity has link  │
│   to friend "张三"   │
│ AND type = 'food'    │
└─────────┬───────────┘



设计系统（让 UI 风格统一，不要每页硬编码）
输出这些“设计 token”（让 AI 引用常量，不要自由发挥）

---

## 六、前端原型复刻（当前实现进度）

本阶段目标：先把安卓应用的“主页 + 新建（含部分详情）”界面骨架搭起来，确保 6 个底部菜单布局固定不变，并为后续逐页逐像素复刻提供落点。

### 6.1 入口与导航

- 应用入口：使用 [app.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/app/app.dart) 挂载 [app_shell.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/app/app_shell.dart)，通过 IndexedStack 固定 6 个 Tab。
- 全局悬浮“+”：由 [app_shell.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/app/app_shell.dart) 统一提供右下角淡蓝色圆形 FAB（位于底部导航之上），点击弹出“添加新记录”底部弹窗，按 3+3 排列提供入口：美食/小确幸/旅行/目标/添加朋友/相遇；其中“添加朋友”跳转到羁绊 Tab 的朋友档案列表，“相遇”跳转到羁绊的相遇新建页；各模块页内不再各自持有 FAB，避免被 BottomNavigationBar 覆盖导致“隐藏在菜单下面”的问题。
- 首页日程：顶部 “AI史官” 按钮跳转 AI 史官聊天页；点击个人头像与右侧“设置”均跳转个人中心：[home_schedule_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/home_schedule/presentation/home_schedule_page.dart)
  - 日历卡：支持左右切换月份，点击年月弹出快速选择面板并更新当前月视图

### 6.2 页面落点（feature-first）

- AI 史官聊天页（原型：AI 史官对话）：[ai_historian_chat_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/ai_historian/presentation/ai_historian_chat_page.dart)
  - 顶部玻璃栏：返回、在线状态、分析/清空入口
  - 会话区：时间戳、AI/用户气泡、推荐卡片
  - 底部输入：快捷指令 Chips + 输入框 + 发送按钮
- 个人中心（原型：个人中心/功能管理入口）：[profile_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/profile/presentation/profile_page.dart)
  - 人生传记卡片与“生成编年史”入口（先以占位页承接）
  - 功能管理列表新增“个人资料”（位于“万物互联”和“提醒设置”之间）：支持编辑用户名/出生日期/身高体重/感情状态（单身汪/有对象/已婚）；用户名同步显示在个人中心头像下方与首页日程左上角，确保全局统一。
- 收藏中心已补齐概览统计、分类筛选与选择模式批量导出/删除入口，并接入本地数据库真实数据：food_records（标题/标签/图片/record_date/is_favorite）、travel_records（标题/目的地/心情/图片/record_date/is_favorite）、moment_records（内容/心情/场景/图片/record_date/is_favorite）、friend_records（姓名/分组/头像/updated_at/is_favorite），仅渲染详情页标记收藏的数据并按时间倒序展示；编年史管理已补齐列表与卡片落地；年度报告/数据管理/模块管理等入口仍以占位页承接
- 美食（原型：美食主页/新建/详情）：[food_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/food/presentation/food_page.dart)
  - 主页：搜索栏、筛选按钮、分段切换（美食记录/心愿清单）、筛选 Chips（日期范围/评分/位置城市/同伴，分别弹窗并支持复合筛选；有筛选值时 Chip 显示淡蓝色）、味觉地图块、双列卡片瀑布流
  - 新建（原型：`2-4 美食-新建美食记录`）：取消/发布、图片九宫格、店名输入、推荐指数、评价/描述、人均消费、相关链接、标签编辑、心愿餐厅开关、地点卡、万物互联索引（关联朋友/旅行/目标/心情）；发布会写入 `food_records`，并将关联朋友/旅行/目标写入 `entity_links/link_logs`
  - 图片选择：图片九宫格支持本地相册多选，图片展示兼容网络与本地路径
  - 详情：对齐 `2-3 美食详情页` 原型（玻璃拟态顶栏、价格/评分/标签/地点/记录文案、瀑布图墙、地图提示、底部圆角操作条）；编辑进入可编辑模式并复用新建页，收藏写入 is_favorite 并用于收藏中心筛选，分享导出长图，点击“再次打卡”预填餐厅名/地点/人均消费；万物互联继续读取 `entity_links` 动态展示关联人物/小确幸/旅行/目标
- 小确幸（原型：小确幸主页/新建/详情）：[moment_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/moment/presentation/moment_page.dart)
  - 主页：搜索栏、筛选/新增按钮、心情分类 Chips、双列卡片瀑布流
  - 新建：添加照片、心情选择、记录输入、万物互联（关联羁绊/美食/旅行/目标）
  - 图片选择：照片九宫格支持本地相册多选，图片展示兼容网络与本地路径
  - 详情：图片 + 心情标签 + 文本内容；万物互联改为读取 `entity_links` 动态展示关联目标/旅行/羁绊/美食
- 旅行（原型：旅行主页/新建/详情）：[travel_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/travel/presentation/travel_page.dart)
  - 主页：搜索栏、筛选/新增按钮、头部信息卡、旅程记录列表、足迹地图块
  - 新建行程（对应原型：`4-3 旅行-新建旅行行程`）：玻璃拟态顶部栏（取消/标题/创建）、封面上传虚线框、标题/备注输入、基本信息分组（目的地/日期范围/预算）、同行者横向邀请区、规划详情（愿望清单开关/预订链接/心愿清单勾选与新增）
  - 行程详情（对应原型：`4-2 旅行-在路上-旅行行程详情`）：头图 Hero + 渐变遮罩 + 底部圆角、玻璃拟态按钮组（返回/收藏/编辑/新增）与“一键导出”、行程信息浮层（天数/地点/标题/日期）、时间线布局（连续竖线 + Day 区块 + 记忆卡/相册卡/美食卡/同行者卡）
  - 新建游记（对应原型：`4-4 旅行-旅行行程-新建旅行游记`）：玻璃拟态顶部栏（取消/发布）、标题/正文输入、九宫格图片区（含虚线“添加照片”格）、地点/心情/同行/关联美食/标签等关联区块与“正在关联行程”提示胶囊
  - 图片选择：新建游记九宫格支持本地相册多选，图片展示兼容网络与本地路径
  - 交互承接：行程详情页顶部“编辑”→新建行程页（作为编辑承接）；顶部“+”与悬浮“+”→新建游记页
  - 复刻辅助：在同一落点内实现虚线圆角边框（用于封面上传框与九宫格添加格），并使用 BackdropFilter 复刻玻璃拟态顶部栏/按钮背景
  - 布局约束：在 CustomScrollView 的 SliverToBoxAdapter 里避免依赖“无限高度”的 Stack/自绘容器；时间线竖线改为基于子内容尺寸绘制、头像叠放区域显式给宽度，确保测试与真实运行一致（`flutter test` 不再出现 `RenderBox was not laid out`）。
- 目标（原型：目标看板/新建/详情）：[goal_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/goal/presentation/goal_page.dart)
  - 主页：目标看板头部卡、进行中目标进度条列表、已完成块
  - 新建：标题/分类/截止时间/描述输入、万物互联选择器（小确幸/美食/羁绊/旅行）
  - 新建保存：写入 `timeline_events(eventType=goal)`，并同步写入 `entity_links/link_logs`（关联小确幸/美食/羁绊/旅行）
  - 关联旅行数据源：`travel_records`（过滤 `is_deleted=false`）
  - 数据读取约定：关联旅行统一走 `AppDatabase.watchAllActiveTravelRecords()` 以复用过滤与排序
  - 详情：目标拆解详情页（圆环进度 Hero、季度树结构、月度目标与每日任务、关联记忆横滑区、底部操作栏“顺延计划/阶段复盘”）
- 羁绊（原型：朋友档案/相遇）：[bond_page.dart](file:///d:/trae/%E4%BA%BA%E7%94%9F%E7%BC%96%E5%B9%B4%E5%9B%BD%E9%99%85/life_chronicle/lib/features/bond/presentation/bond_page.dart)
  - 顶部：标题 + “解析” + 分段切换（朋友档案/相遇）+ 搜索/筛选/新增
  - 朋友档案：双列瀑布流卡片（头像、标签、相识时长、上次见面），数据源切换为 `friend_records`
  - 相遇：时间线样式卡片（日期、标题、摘要、地点摘要、参与者头像与“+N”），数据源为 `timeline_events(eventType=encounter)`，参与者来自 `entity_links(encounter↔friend)`
  - 朋友档案详情：档案卡（头像/认识天数/基础信息/标签/操作按钮）+ AI 洞察入口 + 共同回忆轴（筛选 Pills + 时间线卡片）
  - 相遇新建/详情：从顶部“+”或悬浮“+”进入新建相遇；相遇卡片进入详情页（参与者/正文/图片、地点点击进入高德地图预览、万物互联关联计数）
  - 图片选择：相遇上传照片支持本地相册多选，图片展示兼容网络与本地路径
  - 朋友档案新建：支持头像相册选择并复制到 `media/friend`，未上传头像时以姓名首字母渲染；写入字段包含 name/avatar_path/birthday/meet_way/meet_date/impression_tags/contact_frequency/contact
  - 联络频率：选项为“无需提醒/每一个月提醒一次/每三个月提醒一次/每年提醒一次”，默认“无需提醒”，落库到 `contact_frequency`
  - 日期选择：朋友认识日期/生日使用日期选择（不含时间），相遇记录时间支持“日期+时间”，统一 `zh-CN` 语言环境（依赖 `flutter_localizations`）
- 系统权限：Android 增加读取图库权限以支持本地相册选图（READ_MEDIA_IMAGES/READ_EXTERNAL_STORAGE）
- UI 兼容性约定：当前 Flutter SDK 下颜色透明度统一使用 `Color.withValues(alpha: ...)`，避免 `withOpacity` 的废弃告警影响 `flutter analyze` 基线。
- 日期筛选器中文化：美食/旅行/小确幸筛选日期范围统一 `zh-CN` 语言环境（需要在 `MaterialApp` 配置本地化委托与支持语言）
- 图片持久化：统一使用 `media_storage` 工具将选取图片复制到 `media/<module>`，避免系统清理缓存导致记录图片丢失

### 6.3 未落地清单（对照设计文档/原型）

- 首页日程：那年今日瀑布流、日程事件筛选/详情联动、今日提醒、AI 史官数据联动仍为骨架
- 美食：味觉地图真实数据联动仍待补齐
- 小确幸：筛选/搜索逻辑未接入
- 旅行：行程详情一键导出、旅行心愿清单与预订链接逻辑未接入
- 目标：目标拆解数据结构与进度计算（季度/月/日）未落库，阶段复盘/顺延计划未接入
- 羁绊：朋友档案 AI 洞察、共同回忆轴筛选逻辑未接入
- 羁绊：联络频率提醒通知未接入（基于 `contact_frequency` 与 `last_meet_date` 计算提醒计划）
- 个人中心：年度报告、数据管理、模块管理仍为占位页
- 系统能力：WebDAV/导出能力、AI 智能搜索与洞察尚未接入
收藏中心还是缺少了目标、相遇的彩色小卡片以及个数统计，目前只有美食、旅行、小确幸，需要增加对应的卡片。背后逻辑没有补充完成。

### 6.4 本次实现说明（2026-02-19）

- 根因：羁绊朋友档案仍为静态样例数据，日期选择未中文化且相遇时间只保存日期导致信息损失；多处图片持久化逻辑重复且易被系统清理
- 解决：朋友档案切换为 `friend_records` 实时读取并补齐新建落库/头像持久化/首字母回退；日期与时间选择统一 `zh-CN` 并在相遇记录中保存时分；新增全局 `media_storage` 工具统一图片复制到应用沙盒目录
- 变动：仅涉及界面与数据写入逻辑，无数据库表结构调整；涉及文件包含 `bond_page.dart`、`moment_page.dart`、`food_page.dart`、`travel_page.dart`、`profile_page.dart`、`media_storage.dart`

### 6.5 本次实现说明（2026-02-19 补充）

- 根因：羁绊共同回忆列表卡片样式单一，无法自适应多图展示；长列表随着记录增加可能导致性能问题
- 解决：
  - UI 优化：根据图片数量（0/1/>1）自适应渲染不同卡片布局，多图模式支持九宫格预览（最多9张）与剩余数量提示
  - 性能优化：将 `_FriendMemoryTimeline` 重构为 `_FriendMemorySliver`，使用 `SliverList` 实现虚拟列表渲染，仅渲染可视区域内的卡片
- 变动：涉及 `bond_page.dart`，无数据库变更

### 6.6 本次实现说明（2026-02-19 首页日程修复）

- 根因：`home_schedule_page.dart` 残留未使用的 `intl/table_calendar` 导入与部分可选参数未被任何调用方传参，导致 `flutter analyze` 以 warning 形式失败；同时 AppTheme 引用路径曾写错与遗漏导入 `appDatabaseProvider`，会导致 `AppTheme`/数据库依赖解析失败
- 解决：
  - 告警清理：移除未使用的 `intl/table_calendar` 导入，删除未被使用的可选参数与冗余结构，确保 `flutter analyze` 无告警
  - 引用修正：AppTheme 统一从 `app/app_theme.dart` 引用；数据库 Provider 从 `core/database/database_providers.dart` 引用
  - 测试告警清理：移除 `widget_test.dart` 中未使用的 `dart:typed_data` 导入，降低分析噪音
- 变动：仅涉及导入/依赖与组件参数清理，不涉及数据库表结构调整；相关文件：`home_schedule_page.dart`、`pubspec.yaml`、`widget_test.dart`

### 6.7 本次实现说明（2026-02-19 收藏中心相遇占位 & 首页头像刷新）

- 根因：
  - 首页日程顶部头像：顶部栏为 `StatelessWidget` 且头像路径通过 `FutureBuilder` 直接读取，页面从个人中心返回时不会触发重建，导致头像更新后首页仍显示旧头像
  - 收藏中心“收藏概览”：概览统计仅展示美食/旅行/小确幸，缺少相遇小卡片占位与分类入口，导致功能不完整
- 解决：
  - 首页日程顶部头像：将顶部栏改为 `StatefulWidget`，缓存头像读取 `Future` 并在从个人中心返回后触发刷新
  - 收藏中心“收藏概览”：在概览区域新增“相遇”统计占位卡片，并在分类列表补齐“相遇”分类（当前尚未接入数据源，计数为 0）
- 变动：仅涉及界面逻辑与分类枚举扩展，不涉及数据库表结构调整；相关文件：`home_schedule_page.dart`、`profile_page.dart`

### 6.8 本次实现说明（2026-02-19 美食数据源/筛选搜索 & 羁绊新建档案原型对齐 & 日期选择修复）

- 根因：
  - 美食主页仍使用静态样例数据，导致新建美食记录落库后无法被列表读取；搜索框与筛选 Chips 缺少交互回调，表现为“不可点击/无效果”
  - 首页日程事件流未将美食记录映射为日程事件类型，导致美食新建后在首页日程不展示
  - 日期/时间选择弹窗指定 `zh-CN` 语言环境，但工程未接入 `flutter_localizations` 且 `MaterialApp` 未配置本地化委托/支持语言，导致弹窗无法正常加载
  - 羁绊-新建朋友档案页面布局与原型（`6-5 羁绊-新建朋友档案`）差异较大；朋友档案详情中的信息对齐受布局约束影响出现“居中偏移”
- 解决：
  - 美食主页数据源：改为通过 DAO `watch*` 实时读取 `food_records`，并在 UI 层基于关键词/日期范围/关联朋友进行过滤；心愿清单同样接入真实数据
  - 首页日程：补齐 `food` 事件类型映射，并基于美食记录 `record_date` 注入当日事件流
  - 本地化与日期选择：补齐 `flutter_localizations` 依赖，在 `MaterialApp` 配置 `localizationsDelegates` 与 `supportedLocales`，确保 `showDatePicker/showTimePicker/showDateRangePicker` 可加载 `zh-CN`
  - 羁绊新建档案：按原型重排顶部栏/头像区/信息卡/联络频率弹窗/备注与标签交互；朋友档案详情信息块改为左对齐布局
- 变动：仅涉及 UI 与数据读取/交互逻辑调整，不涉及数据库表结构调整；相关文件：`food_page.dart`、`home_schedule_page.dart`、`bond_page.dart`、`pubspec.yaml`、`app.dart`

### 6.9 本次实现说明（2026-02-19 羁绊档案列表搜索筛选 & 档案编辑删除 & 收藏置顶）

- 根因：
  - 羁绊页头部搜索框为占位文案，未接入输入/状态管理；筛选按钮仅弹窗但未作用于列表；列表顶部 padding 较大导致“搜索框与档案卡片间空隙明显”
  - 档案详情页“编辑档案/收藏/⋮”按钮缺少实现；删除档案后未清理 `entity_links`，可能导致其他模块详情页读取到无效关联从而报错
- 解决：
  - 列表与搜索：搜索框改为可输入 TextField，并在朋友档案列表按关键词（姓名/备注/认识途径/标签等）实时过滤；收敛列表顶部 padding，消除大空白
  - 筛选联动：筛选弹窗的日期范围/朋友勾选回填到羁绊页状态，并对列表进行过滤
  - 收藏置顶：复用 `friend_records.is_favorite`，在详情页点击收藏切换写入数据库；列表排序“收藏优先 + updatedAt 倒序”
  - 编辑复用新建：新建档案页支持传入 `initialFriend` 作为编辑模式，保存时 upsert 同一 id 并保留 createdAt/isFavorite
  - 删除处理：详情页右上角“⋮”提供删除入口；删除时事务内先删除该朋友相关的所有 `entity_links`，再 softDelete 朋友档案，避免万物互联残留引用
- 变动：
  - DAO：`FriendDao` 新增 `watchById` 与 `updateFavorite` 供详情页与收藏置顶使用
  - UI：`bond_page.dart`、`app_shell.dart`（全局悬浮“添加朋友”直达新建档案）

### 6.10 本次实现说明（2026-02-19 美食地图SDK切换 & 地点选择/预览/外部导航）

- 根因：
  - `amap_flutter_map 3.0.0` 在当前 Flutter/Dart 版本下依赖了已移除的 `hashValues`，导致 `flutter test` 编译失败
  - 引入地图插件后，插件内部定义的 `Size` 与 Flutter 的 `Size` 同名，若直接导入会引发类型冲突与错误覆盖
- 解决：
  - SDK切换：移除 `amap_flutter_base/amap_flutter_map`，改用 `amap_flutter` 插件恢复可编译；同时保持地点搜索仍使用高德 Web 服务 REST（`/v3/place/text`）
  - 地点选择：新建美食的地点卡片改为点击跳转地点选择页；支持输入关键词搜索地点并点击结果回填（名称/地址/经纬度），并在地图上打点与自动聚焦；同时支持长按地图直接选点
  - 详情预览：美食详情页点击地图区块进入地图预览页，右上角支持外部导航（高德/百度/腾讯 URL Scheme）
  - 命名冲突：将地图插件按别名导入（`amap`），避免与 Flutter 类型（如 `Size`）冲突
  - Key 管理：Web 服务 Key 通过 `--dart-define=AMAP_WEB_KEY=...` 注入运行时环境，避免写入仓库
- 变动：仅涉及依赖与页面交互/地图组件实现，不涉及数据库表结构调整；相关文件：`food_page.dart`、`pubspec.yaml`

### 6.11 本次实现说明（2026-02-19 小确幸详情页原型对齐）

- 根因：
  - 小确幸详情页未按原型布局呈现，标题/正文/心情/标签/图片/时间地点顺序与交互入口缺失
  - 右上角更多操作缺少删除入口，未体现删除需同步清理万物互联关联的数据约束
  - 分享按钮未体现“自动生成长图”的交互反馈
- 解决：
  - 调整详情页主内容顺序：标题与正文上置，新增心情标识，标签与图片展示靠前，日期时间/地点移动到图片下方
  - 图片区域改为自适应多图网格布局，确保多图完整展示
  - 顶部“更多”补齐删除入口与同步清理万物互联提示，底部编辑/收藏/分享三按钮分别承接新建页、收藏中心与长图预览区域
  - 增加分享长图预览区，体现自动生成长图的结果态
- 变动：仅涉及前端原型页面结构调整，不涉及数据库表结构调整；相关文件：`前端/stitch_home_schedule_dashboard/3-2 小确幸-详情页/code.html`

### 6.12 本次实现说明（2026-02-19 小确幸编辑/定位/日程联动补齐）

- 根因：
  - 小确幸详情页缺少编辑入口，无法复用新建页进行编辑
  - 地理位置仍为文本输入，未与高德地图 SDK 统一
  - 列表仍使用静态样例数据，发布后无法实时展示
  - 发布仅写入 `moment_records`，未同步写入 `timeline_events`，导致首页日程无法关联
- 解决：
  - 编辑复用：详情页新增编辑入口，`MomentCreatePage` 支持 `initialRecord` 预填与更新，保存保留 `createdAt`
  - 地图统一：新增小确幸地图选择/预览页面，复用高德 SDK 初始化与地点搜索逻辑，支持手动填写与外部导航
  - 真实取数：小确幸主页列表改为订阅 `momentDao.watchAllActive()` 实时数据
  - 日程关联：发布/编辑同步 upsert `timeline_events(eventType=moment)`，recordDate 按日期归一化，万物互联编辑时先清理旧关联再写入新关联
- 变动：
  - UI：`moment_page.dart`（详情编辑入口、小确幸新建编辑模式、地图选择/预览、列表取数）
  - 数据：`moment_records` 写入经纬度与地理位置文本，`timeline_events` 同步小确幸事件，无新增表结构

### 6.13 本次实现说明（2026-02-20 美食主页四维筛选与复合筛选）

- 根因：
  - 美食主页筛选 Chips 均复用同一入口，无法分别筛选日期范围/评分/城市/同伴；同时缺少“已筛选状态”提示，用户不易判断当前筛选条件
  - 位置筛选缺少“仅展示已落库城市”的约束，无法满足按已有数据快速筛选的使用诉求
  - 同伴筛选缺少“独享（无关联朋友）”场景，无法筛出单人探店记录
- 解决：
  - 将搜索框下方 4 个筛选 Chips 拆分为独立弹窗：日期范围（含自定义范围）、评分（1-5 星可多选）、位置（城市列表仅来自已落库地点地址解析结果）、同伴（羁绊朋友 + 独享）
  - 支持复合筛选：日期/评分/城市/同伴四类条件以 AND 方式叠加；同伴内部支持朋友 OR 独享
  - 已筛选高亮：当任意筛选项存在筛选值时，对应 Chip 使用淡蓝色样式提示
- 数据约定：
  - 城市来源：从 `food_records.poi_address`（回退 `food_records.city`）解析出城市 token 后去重展示，保证只出现已落库的城市
  - 同伴来源：羁绊朋友来自 `friend_records`；“独享”通过判断该 food 是否存在 `entity_links(sourceType=food,targetType=friend)` 关联实现
- 变动：仅涉及美食主页 UI 与筛选逻辑，不涉及数据库表结构调整；相关文件：`food_page.dart`

### 6.14 本次实现说明（2026-02-20 新建保存失败/历史数据“丢失”修复：数据库迁移兜底与旧库兼容）

- 根因：
  - 数据库升级路径仅按版本号顺序执行部分迁移步骤，存在“表已引入但迁移未创建”的缺口：升级后可能缺失 `timeline_events/entity_links/link_logs` 等表，导致新建保存时写入这些表直接抛错，表现为“无法保存/无法新建”
  - 本地数据库文件名缺少兼容迁移：若历史版本使用过不同 db 文件名，升级后会创建并读取新的空库文件，表现为“历史数据都丢失”
- 解决：
  - 升级迁移改为幂等兜底：升级时先检测并补齐所有必需表的创建，再检测并补齐必需列（is_favorite、poi_name/poi_address、经纬度等），并在列存在时执行数据回填语句，确保任意版本跳跃升级后也能正常读写
  - 旧库文件名兼容：iOS/Android 打开数据库时，若发现当前库文件不存在或为空，会尝试将常见旧文件名（`life_chronicle.db/app.sqlite/app.db`）迁移到 `life_chronicle.sqlite`，避免读到新空库
  - 回归用例：新增数据库升级场景测试（模拟缺失表 + user_version 回退后再次打开）验证可正常插入三张关键表
- 变动：仅涉及数据库连接与迁移策略调整，不涉及新增表结构；相关文件：`app_database.dart`、`db_connection_io.dart`、`widget_test.dart`

### 6.15 本次实现说明（2026-02-20 羁绊档案共同回忆补齐小确幸 & Android 构建修复）

- 根因：
  - 羁绊朋友档案的共同回忆轴仅展示 `timeline_events(eventType=encounter)`，未从 `entity_links(friend↔moment)` 聚合小确幸，导致“万物互联关联了羁绊朋友，但朋友档案里看不到小确幸”
  - Android 侧同时引入 `com.amap.api:3dmap` 与 `com.amap.api:location`，两者包含重叠类（如 `com.amap.api.fence.*`），触发 `checkReleaseDuplicateClasses` 失败
  - 工程依赖存在“可用新版本但不满足当前依赖约束”的告警，影响构建输出可读性与排查效率
- 解决：
  - 羁绊档案共同回忆轴改为以“朋友”为入口订阅其 `entity_links`，按对端实体类型分别拉取 `moment_records/food_records/travel_records` 与 `timeline_events(encounter)`，统一映射为回忆卡片渲染
  - Android 依赖仅保留 `3dmap`，移除 `location`，消除重复类冲突
  - 依赖告警收敛：在不改架构/不换库的前提下，升级 `share_plus/flutter_lints/sqlite3_flutter_libs` 到可解析的较新版本；`sqlite3_flutter_libs` 受 `drift_flutter` 约束仍保持在 `0.5.x`
- 变动：
  - UI：`bond_page.dart`
  - Android：`android/app/build.gradle.kts`
  - 依赖：`pubspec.yaml`

### 6.16 本次实现说明（2026-02-20 美食心愿清单详情页对齐 & “标记为已品尝”流转）

- 根因：
  - 美食“心愿清单”详情页直接复用普通美食详情页，文案与信息结构不一致，底部按钮也未按原型提供“编辑/分享/标记为已品尝”
  - “标记为已品尝”缺少从心愿清单到美食记录的状态流转闭环，导致心愿清单无法被正确移除
- 解决：
  - 详情页按 `isWishlist` 分支渲染：心愿清单隐藏顶部标题栏，主内容改为“心愿备注/美食标签/打卡相册/万物关联”分区；普通美食保持原详情结构
  - 底部操作条按 `isWishlist` 切换：心愿清单显示“编辑/分享/标记为已品尝”，普通美食保持“编辑/收藏/分享/再次打卡”
  - 已品尝流转：点击“标记为已品尝”进入美食编辑发布页并自动取消“加入心愿清单”，保存发布后返回美食页并切换到“美食记录”分段；由于记录 `isWishlist=false`，该条会从心愿清单实时移除
- 变动：
  - UI：`food_page.dart`（心愿清单详情结构、底部按钮、回到美食记录分段）
  - 写入：`FoodCreatePage` 支持覆盖 `isWishlist/wishlistDone` 并在发布后可携带返回结果用于页面联动（不涉及数据库表结构调整）

### 6.17 本次实现说明（2026-02-20 点击地理位置闪退（Android 15）修复）

- 根因：
  - 地点页内嵌地图使用 `amap_flutter`，其内置 native 库 `libAMapOpenMap.so` 在 Android 15 上触发 JNI `GetStaticMethodID(java.lang.Runtime.nativeLoad)` 失败，进程直接 abort，属于 native 层致命崩溃，无法在 Dart `try/catch` 内捕获
- 解决：
  - 在进入地点页时通过 MethodChannel 获取 `Build.VERSION.SDK_INT`；当 `SDK_INT >= 35 (Android 15)` 时禁用内嵌地图初始化与渲染，避免触发 native 库加载
  - 保留地点能力：预览页仍可“外部导航”；选择页仍可“搜索地点（Web API）/手动填写/选中写入经纬度”，确保各安卓版本不闪退且功能可用
- 变动：
  - Flutter：`amap_location_page.dart`（增加版本判定与降级渲染）
  - Android：`MainActivity.kt`（新增设备版本查询 MethodChannel，不涉及包结构调整）


## 四、功能模块详细设计

### 4.1 小确幸模块
#### 4.1.1 详情页设计与实现
- **布局策略**：采用纵向流式布局（标题 -> 描述 -> 标签 -> 地理位置 -> 发布时间 -> 图片 -> 万物互联），移除顶部 AppBar 标题以增加沉浸感。
- **多图渲染引擎**：
  - **单图**：16:9 大图展示，强调视觉冲击。
  - **双图**：1:1 并排展示。
  - **三图**：左一大图（2/3 宽），右两小图纵向排列。
  - **四图及以上**：九宫格 Grid 布局，自动裁剪。
  - **交互**：集成 `InteractiveViewer` 实现点击全屏查看与手势缩放。
- **万物互联展示**：基于 `entity_links` 表查询关联数据，按类型（朋友/美食/旅行/目标）分组渲染 Chip 标签。
- **数据一致性保障**：
  - **删除逻辑**：执行“级联清理 + 硬删除”，先删除 `entity_links` 中以当前记录为 source 或 target 的所有关联条目，再删除 `moment_records` 与对应的 `timeline_events(eventType=moment)` 记录，避免软删除残留与关联脏数据。
- **分享机制**：使用 `RepaintBoundary` 捕获详情页 UI 渲染树，生成高倍率（3x）PNG 图片，通过 `share_plus` 调用系统原生分享。
